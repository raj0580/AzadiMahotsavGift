<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Submissions</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div id="auth-container">
            <h1>Admin Login</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="cta-button">Login</button>
            </form>
        </div>

        <div id="admin-panel" class="hidden">
            <header>
                <h1>Reward Submissions</h1>
                <button id="logout-btn" class="cta-button">Logout</button>
            </header>
            <main>
                <div class="controls">
                    <button id="export-csv" class="cta-button">Export to CSV</button>
                </div>
                <div class="table-container">
                    <table id="submissions-table">
                        <thead>
                            <tr>
                                <th data-sort="timestamp">Timestamp</th>
                                <th data-sort="name">Name</th>
                                <th data-sort="phone">Phone</th>
                                <th data-sort="upi">UPI ID</th>
                                <th data-sort="reward">Reward</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Your Scripts -->
    <script src="firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const auth = firebase.auth();
            const db = firebase.firestore();

            const authContainer = document.getElementById('auth-container');
            const adminPanel = document.getElementById('admin-panel');
            const loginForm = document.getElementById('login-form');
            const logoutBtn = document.getElementById('logout-btn');
            const submissionsTableBody = document.querySelector('#submissions-table tbody');
            const exportBtn = document.getElementById('export-csv');

            let submissionsData = [];
            let sortConfig = { key: 'timestamp', direction: 'desc' };

            auth.onAuthStateChanged(user => {
                if (user) {
                    authContainer.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    fetchSubmissions();
                } else {
                    authContainer.classList.remove('hidden');
                    adminPanel.classList.add('hidden');
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => alert(error.message));
            });

            logoutBtn.addEventListener('click', () => auth.signOut());

            function fetchSubmissions() {
                db.collection('submissions').orderBy(sortConfig.key, sortConfig.direction).onSnapshot(snapshot => {
                    submissionsData = [];
                    submissionsTableBody.innerHTML = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        submissionsData.push(data);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A'}</td>
                            <td>${data.name}</td>
                            <td>${data.phone}</td>
                            <td>${data.upi}</td>
                            <td>${data.reward}</td>
                        `;
                        submissionsTableBody.appendChild(row);
                    });
                });
            }

            exportBtn.addEventListener('click', () => {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Timestamp,Name,Phone,UPI,Reward\n";
                submissionsData.forEach(item => {
                    const row = [
                        item.timestamp ? `"${new Date(item.timestamp.seconds * 1000).toLocaleString()}"` : 'N/A',
                        `"${item.name}"`,
                        `"${item.phone}"`,
                        `"${item.upi}"`,
                        `"${item.reward}"`
                    ].join(",");
                    csvContent += row + "\r\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "submissions.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            document.querySelectorAll('#submissions-table th').forEach(headerCell => {
                headerCell.addEventListener('click', () => {
                    const key = headerCell.dataset.sort;
                    const direction = (sortConfig.key === key && sortConfig.direction === 'asc') ? 'desc' : 'asc';
                    sortConfig = { key, direction };
                    fetchSubmissions();
                });
            });
        });
    </script>
</body>
</html>